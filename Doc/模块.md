# 模块详细说明

## 1. 传感器模块

### DHT11 (温湿度)
*   **原理**：单总线数字传感器。
*   **驱动**：`components/dht11`
*   **实现**：通过微秒级延时模拟单总线时序读取 40 bit 数据。
*   **注意**：读取间隔建议 > 2秒。

### BH1750 (光照)
*   **原理**：I2C 接口数字光强度传感器。
*   **驱动**：`components/bh1750`
*   **实现**：使用 ESP32 I2C 驱动，工作在连续高分辨率模式。
*   **地址**：默认 0x23。

### MQ-2 (烟雾)
*   **原理**：气敏电阻，浓度越高电压越高。
*   **驱动**：`components/mq2`
*   **实现**：使用 ESP32 ADC1 读取模拟电压值 (0-4095)。

## 2. 执行器模块

### LED 控制
*   **驱动**：`components/led`
*   **技术**：LEDC (LED Control) 外设。
*   **参数**：5kHz 频率，8位分辨率 (0-255)。

### 风扇控制 (Fan)
*   **驱动**：`components/fan`
*   **硬件**：L9110S 或 MOS 管驱动风扇
*   **引脚**：GPIO 18, PWM Channel 1
*   **驱动**：LEDC PWM
*   **逻辑**：
    *   低电平有效/控制。
    *   APP/Web 可滑动调节速度 (0-255)。
    *   **自动温控**：温度 > 30℃ 自动开启。

### 窗帘控制 (Curtain)
*   **硬件**：SG90 或类似舵机 (Servo)
*   **引脚**：GPIO 8 (PWM 信号)
*   **驱动**：PWM (LEDC)
    *   **频率**：50Hz
    *   **控制**：通过调整占空比控制角度 (0° ~ 180°)。
    *   **逻辑**：Web 点击 "OPEN" 转至 180°，"CLOSED" 转至 0°。

## 3. 🎤 语音识别模块

### INMP441 (数字麦克风)
*   **原理**：I2S 接口 MEMS 麦克风，24 位精度。
*   **驱动**：`components/sr/inmp441_driver.c`
*   **引脚**：
    *   SCK: GPIO 40 (I2S 时钟)
    *   WS: GPIO 41 (字选择/帧同步)
    *   SD: GPIO 42 (数据输入)
*   **采样率**：16000 Hz
*   **数据格式**：32 位字，高 24 位有效

### AFE 音频前端处理器
*   **驱动**：`components/sr/afe_processor.c`
*   **模式**：`AFE_TYPE_SR` (语音识别优化模式)
*   **功能**：
    *   **NS (降噪)**：NSNet2 神经网络降噪
    *   **VAD (语音活动检测)**：检测是否有人说话
    *   **WakeNet (唤醒词检测)**：内置于 AFE，检测 "你好小智"
*   **架构**：参考 xiaozhi-esp32 实现

### 双任务架构
系统采用双任务设计，避免 CPU 阻塞导致看门狗超时：

```
┌─────────────────────────────────────────────────────────┐
│  vr_feed_task (CPU 0, 优先级 5)                          │
│  ├── I2S 读取麦克风数据 (int32_t)                        │
│  ├── 转换为 16-bit PCM                                   │
│  └── 喂入 AFE 处理器                                     │
└─────────────────────────┬───────────────────────────────┘
                          │ AFE 内部处理 (NS + VAD + WakeNet)
                          ▼
┌─────────────────────────────────────────────────────────┐
│  vr_detect_task (CPU 1, 优先级 3)                        │
│  ├── AFE fetch (阻塞等待，释放 CPU)                      │
│  ├── 检查 wakeup_state (唤醒词由 AFE 内部检测)           │
│  └── MultiNet 命令词识别 (外部处理)                      │
└─────────────────────────────────────────────────────────┘
```

### ESP-SR 语音识别
*   **驱动**：`components/sr/voice_recognition.c`
*   **模型**：
    *   **WakeNet**：唤醒词检测（默认 "你好小智"），由 AFE 内部处理
    *   **MultiNet**：命令词识别（中文 mn7_cn），外部处理
*   **配置**：在 `config.h` 中设置
    ```c
    #define SR_WAKENET_MODEL "wn9_nihaoxiaozhi"
    #define SR_MULTINET_MODEL "mn7_cn"
    #define SR_WAKENET_MODE DET_MODE_95
    ```
*   **支持的命令**：
    | 命令词 | 拼音 | 功能 |
    |--------|------|------|
    | 打开灯光 | da kai deng guang | 开灯 |
    | 关闭灯光 | guan bi deng guang | 关灯 |
    | 打开风扇 | da kai feng shan | 开风扇 |
    | 关闭风扇 | guan bi feng shan | 关风扇 |
*   **状态机**：
    ```
    VR_STATE_WAITING_WAKE  ──(唤醒词)──▶  VR_STATE_WAITING_COMMAND
           ▲                                      │
           └────────(命令识别/超时)───────────────┘
    ```
*   **回调机制**：
    *   语音命令通过回调函数传递到 `app_control`
    *   实现了与硬件控制的完全解耦

## 4. 网络与交互

### WiFi
*   **模式**：Station (STA) 模式，连接家中路由器。
*   **特性**：包含断线自动重连机制（最多重试 5 次）。

### HTTP Server
*   **框架**：ESP-HTTPD。
*   **功能**：
    *   **静态页面**：内嵌 HTML/CSS/JS 页面。
    *   **Data API** (`/api/data`)：返回 JSON 格式的所有传感器数据状态。
    *   **Control API**：接收 GET 请求控制设备（如 `/api/fan/speed?value=128`）。

