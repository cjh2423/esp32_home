# 音频架构文档

## 概述

本项目的语音识别系统基于 ESP-SR 框架，参考 xiaozhi-esp32 实现，采用双任务架构设计。

## 音频数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           硬件层                                         │
├─────────────────────────────────────────────────────────────────────────┤
│  INMP441 麦克风 (I2S)                                                    │
│  ├── SCK: GPIO 40                                                       │
│  ├── WS:  GPIO 41                                                       │
│  └── SD:  GPIO 42                                                       │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ I2S 读取 (32-bit, 16kHz)
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  vr_feed_task (CPU 0, 优先级 5)                                          │
│  ├── inmp441_read() → i2s_buffer (int32_t)                              │
│  ├── 转换: int32_t >> 16 → int16_t (取高16位)                            │
│  └── afe_processor_feed(audio_buffer)                                   │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ 16kHz, 16-bit PCM
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  AFE 处理器 (AFE_TYPE_SR 模式)                                           │
│  ├── NS (降噪): NSNet2 神经网络                                          │
│  ├── VAD (语音活动检测)                                                  │
│  └── WakeNet (唤醒词检测): "你好小智" 内置                                │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ afe_fetch_result_t
                                │ ├── data (处理后音频)
                                │ ├── vad_state
                                │ └── wakeup_state ← 唤醒检测结果
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  vr_detect_task (CPU 1, 优先级 3)                                        │
│  ├── afe_processor_fetch_ex() → 阻塞等待                                 │
│  ├── 状态机:                                                            │
│  │   ├── VR_STATE_WAITING_WAKE                                          │
│  │   │   └── if wakeup_state == WAKENET_DETECTED → 切换到命令模式        │
│  │   └── VR_STATE_WAITING_COMMAND                                       │
│  │       └── MultiNet 命令词识别                                         │
│  └── 回调: s_callback(VR_CMD_xxx)                                       │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  命令处理 (main.c 回调)                                                  │
│  ├── VR_CMD_WAKE_UP   → 唤醒提示                                        │
│  ├── VR_CMD_LIGHT_ON  → "打开灯光"                                      │
│  ├── VR_CMD_LIGHT_OFF → "关闭灯光"                                      │
│  ├── VR_CMD_FAN_ON    → "打开风扇"                                      │
│  └── VR_CMD_FAN_OFF   → "关闭风扇"                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. INMP441 驱动 (`inmp441_driver.c`)

| 参数 | 值 |
|------|-----|
| 接口 | I2S |
| 采样率 | 16000 Hz |
| 位深 | 32-bit (有效 24-bit) |
| 通道 | 单声道 (左声道) |

### 2. AFE 处理器 (`afe_processor.c`)

| 参数 | 值 |
|------|-----|
| 模式 | AFE_TYPE_SR |
| NS | NSNet2 神经网络降噪 |
| VAD | 最高灵敏度 (VAD_MODE_4) |
| WakeNet | 内置于 AFE |
| 内存 | PSRAM 优先 |

**关键配置**：
```c
#define AFE_PROCESSOR_CONFIG_DEFAULT() {
    .enable_ns = true,
    .enable_vad = true,
    .enable_wakenet = true,      // 启用内置 WakeNet
    .enable_agc = false,
    .use_psram = true,
    .vad_mode = VAD_MODE_4,
    .vad_min_noise_ms = 50,
    .afe_perferred_core = 1,
    .afe_perferred_priority = 1
}
```

### 3. 语音识别 (`voice_recognition.c`)

**状态机**：
```
VR_STATE_WAITING_WAKE  ──(wakeup_state==DETECTED)──▶  VR_STATE_WAITING_COMMAND
         ▲                                                     │
         └──────────(ESP_MN_STATE_DETECTED / TIMEOUT)──────────┘
```

**任务分配**：

| 任务 | CPU | 优先级 | 栈大小 | 职责 |
|------|-----|--------|--------|------|
| vr_feed_task | 0 | 5 | 4KB | I2S 读取 + AFE 喂入 |
| vr_detect_task | 1 | 3 | 8KB | AFE 获取 + 模型检测 |

## 模型配置

在 `config.h` 中配置：

```c
// 唤醒词模型
#define SR_WAKENET_MODEL "wn9_nihaoxiaozhi"

// 命令词模型
#define SR_MULTINET_MODEL "mn7_cn"

// 唤醒灵敏度
#define SR_WAKENET_MODE DET_MODE_95
```

## 支持的语音命令

| 命令 ID | 命令词 | 拼音 | 枚举值 |
|---------|--------|------|--------|
| 1 | 打开灯光 | da kai deng guang | VR_CMD_LIGHT_ON |
| 2 | 关闭灯光 | guan bi deng guang | VR_CMD_LIGHT_OFF |
| 3 | 打开风扇 | da kai feng shan | VR_CMD_FAN_ON |
| 4 | 关闭风扇 | guan bi feng shan | VR_CMD_FAN_OFF |

## 关键设计决策

### 为什么使用 AFE_TYPE_SR？

1. **WakeNet 内置**：唤醒词检测由 AFE 内部完成，通过 `wakeup_state` 获取结果
2. **减少 CPU 占用**：避免外部调用 WakeNet 导致的额外开销
3. **参考实现**：与 xiaozhi-esp32 保持一致

### 为什么使用双任务架构？

1. **避免看门狗超时**：NSNet2 降噪是 CPU 密集型操作
2. **任务分离**：Feed 任务专注数据采集，Detect 任务专注模型推理
3. **核心隔离**：Feed 在 CPU0，Detect 在 CPU1，互不干扰

### fetch_with_delay 的作用

```c
afe_fetch_result_t *res = afe_iface->fetch_with_delay(afe_data, portMAX_DELAY);
```

- 阻塞等待 AFE 处理完成
- 自动释放 CPU 给其他任务
- 避免忙等待导致的 CPU 占用

## 文件结构

```
components/sr/
├── afe_processor.c      # AFE 封装实现
├── afe_processor.h      # AFE 接口定义
├── inmp441_driver.c     # I2S 麦克风驱动
├── inmp441_driver.h     # 麦克风接口定义
├── voice_recognition.c  # 语音识别主逻辑
├── voice_recognition.h  # 语音识别接口
└── CMakeLists.txt       # 组件构建配置
```

## 调试日志

启动时的正常日志：
```
I (xxx) AFE: AFE created (type: SR, feed: 512, fetch: 512, NS: ON, VAD: ON, WakeNet: ON)
I (xxx) VR: WakeNet integrated in AFE (AFE_TYPE_SR mode)
I (xxx) VR: MultiNet ready (4 commands)
I (xxx) VR: Voice recognition initialized (AFE_TYPE_SR mode)
I (xxx) VR: Feed task started (chunksize: 512)
I (xxx) VR: Detect task started (chunksize: 512)
I (xxx) VR: Voice recognition started (dual-task, AFE_TYPE_SR)
```

唤醒和命令识别日志：
```
I (xxx) VR: Wake word detected! (by AFE internal WakeNet)
I (xxx) VR: Command detected: ID 1
```
